using Debricked.Helpers;
using Debricked.Models.Constants;
using System;
using System.Collections.Generic;
using System.Text.Json.Serialization;
using System.Text.RegularExpressions;

namespace Debricked.Models.DebrickedApi
{
    internal class DebrickedVulnerability
    {
        #region Public properties
        [JsonPropertyName("cveId")]
        public string CveId { get; set; }

        [JsonIgnore]
        public decimal Cvss { get { return this._cvss is null ? 0 : this._cvss.Text; } }

        [JsonPropertyName("isDisputed")]
        public bool IsDisputed { get; set; }

        [JsonIgnore]
        public DateTime Discovered { get { return ConversionHelper.TimestampMsToDateTime(this.discoveredTimestamp); } }

        [JsonPropertyName("usesVulnerableFunctionality")]
        public string UsesVulnerableFunctionality { get; set; }

        [JsonIgnore]
        public VulnerabilityStatusEnum VulnerabilityStatus { get {return this.VulnerabilityStatuses is null || this.VulnerabilityStatuses.Count==0 ? ConversionHelper.StringToEnum<VulnerabilityStatusEnum>(this.VulnerabilityStatusString) : ConversionHelper.StringToEnum<VulnerabilityStatusEnum>(this.VulnerabilityStatuses.Find((v) => v.Amount > 0).Type); } }

        [JsonPropertyName("vulnerabilityStatus")]
        public string VulnerabilityStatusString { get; set; }

        [JsonIgnore]
        public string Link { get { return this.Name.Link; } set { this.Name.Link = value; } }

        [JsonIgnore]
        public string PackageName { get { return this.Name.Link; } }

        [JsonIgnore]
        public int Id { get; set; } = -1;

        [JsonIgnore]
        public bool IsRootFixAvailable = false;

        [JsonIgnore]
        public bool IsDirectFixAvailable = false;

        [JsonPropertyName("discovered")]
        public long discoveredTimestamp { get; set; }

        [JsonPropertyName("name")]
        public DebrickedVulnerabilityName Name { get; set; }

        [JsonPropertyName("cvss")]
        public DebrickedVulnerabilityCvss _cvss { get; set; }

        [JsonPropertyName("vulnerabilityStatuses")]
        public List<DebrickedVulnerabilityStatus> VulnerabilityStatuses { get; set; } = new List<DebrickedVulnerabilityStatus>();

        [JsonPropertyName("dependencies")]
        public List<DebrickedDependency.DebrickedDependencyName> DependencyNames { get; set; } = new List<DebrickedDependency.DebrickedDependencyName>();

        [JsonIgnore]
        public List<DebrickedDependencyTreeNode> Trees { get; set; } = new List<DebrickedDependencyTreeNode>();

        [JsonIgnore]
        public Dictionary<String, HashSet<DebrickedVulnTimeLineInterval>> VulnerabilityTimelineIntervals { get; set; } = new Dictionary<string, HashSet<DebrickedVulnTimeLineInterval>>();

        [JsonIgnore]
        public List<DebrickedVulnRefSummary> RefSummaries { get; set; } = new List<DebrickedVulnRefSummary>();
        #endregion


        public int GetId(Regex re)
        {
            if (this.Id == -1)
            {
                var matches = re.Matches(this.Link);
                if(matches.Count >=1 && matches[0].Groups.Count >= 2)
                {
                    this.Id = int.Parse(matches[0].Groups[1].Value);
                }
            }
            return this.Id;
        }

        public HashSet<int> GetDepenciesIds(Regex re)
        {
            HashSet<int> ids = new HashSet<int>();
            foreach (var dependency in this.DependencyNames)
            {
                ids.Add(dependency.GetId(re));
            }
            return ids;
        }

        public HashSet<String> GetDependenciesNames()
        {
            HashSet<String> names = new HashSet<string>();
            foreach (var dependency in this.DependencyNames)
            {
                names.Add(dependency.Name);
            }
            return names;
        }

        #region Classes
        public class DebrickedVulnerabilityStatus   
        {
            [JsonPropertyName("type")]
            public string Type { get; set; }

            [JsonPropertyName("amount")]
            public int Amount { get; set; }
        }

        public class DebrickedVulnerabilityName
        {
            [JsonPropertyName("name")]
            public string Name { get; set; }

            [JsonPropertyName("link")]
            public string Link { get; set; }
        }

        public class DebrickedVulnerabilityCvss
        {
            [JsonPropertyName("type")]
            public string Type { get; set; }

            [JsonPropertyName("text")]
            public decimal Text { get; set; }
        }

        public class DebrickedVulnerabilityFixesAndExploitsEntry
        {
            [JsonPropertyName("type")]
            public string Type { get; set; }

            [JsonPropertyName("amount")]
            public int Amount { get; set; }
        }


        #endregion
    }
}
